<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>thIAguinho Pace Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&family=Orbitron:wght@900&display=swap" rel="stylesheet">
    <style>
        /* A custom style block for fine-tuning the UI and animations */
        html {
            background-color: #0c0a09; /* Stone 950 */
        }
        body {
            font-family: 'Roboto Mono', monospace;
            touch-action: manipulation;
            background: radial-gradient(circle at top, #1c1917 0%, #0c0a09 100%);
            overscroll-behavior: none;
        }
        .display-font {
            font-family: 'Orbitron', sans-serif;
        }
        .metric-value {
            transition: color 0.5s ease, background-color 0.5s ease;
        }
        /* Custom colors for pace feedback, providing better visual contrast */
        .bg-pace-ok { background-color: #10B981; } /* Emerald 500 */
        .text-pace-ok { color: #10B981; }
        .bg-pace-fast { background-color: #EF4444; } /* Red 500 */
        .text-pace-fast { color: #EF4444; }
        .bg-pace-slow { background-color: #3B82F6; } /* Blue 500 */
        .text-pace-slow { color: #3B82F6; }
        .bg-pace-standby { background-color: #4B5563; } /* Slate 600 */
        .text-pace-standby { color: #6B7280; } /* Slate 500 */

        /* Animation for the tactical advice card */
        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .tactic-card-animation {
            animation: slideInUp 0.6s ease-out forwards;
        }
        /* Prevents the blue highlight on tap for buttons on mobile */
        button {
            -webkit-tap-highlight-color: transparent;
        }
    </style>
</head>
<body class="text-gray-200 flex flex-col h-screen antialiased">

    <!-- Main Application Container -->
    <div id="app-container" class="flex flex-col h-full p-4 max-w-md mx-auto w-full">

        <!-- Header -->
        <header class="text-center pt-2">
            <h1 class="text-3xl font-bold text-amber-400 display-font tracking-wider">thIAguinho Pace Pro</h1>
            <p class="text-sm text-gray-500">Missão: Pódio Rodobens 10K</p>
        </header>

        <!-- Live Metrics Panel -->
        <main class="flex flex-col items-center justify-center gap-4 flex-grow">
            
            <!-- Primary Metric: Current Pace -->
            <div class="w-full text-center">
                <p class="text-lg text-gray-400">RITMO ATUAL (/km)</p>
                <div id="current-pace" class="metric-value text-8xl lg:text-9xl font-bold bg-pace-standby text-gray-800 rounded-lg py-2 transition-all duration-300">
                    --:--
                </div>
            </div>

            <!-- Visual Pace Feedback -->
            <div class="w-full text-center">
                <p id="pace-status-text" class="text-xl font-bold text-pace-standby h-6 transition-colors duration-300">AGUARDANDO</p>
            </div>
            
            <!-- Tactical Intelligence Card -->
            <div id="tactic-card" class="w-full bg-stone-800/50 p-4 rounded-lg border border-stone-700 mt-4">
                 <div class="text-center">
                    <p class="text-base text-gray-400 font-bold tracking-widest">ESTRATÉGIA KM <span id="current-km-label" class="display-font">1</span></p>
                </div>
                <div class="text-center mt-2">
                    <p id="tactic-terrain" class="text-xl text-amber-400 font-bold"></p>
                    <p id="tactic-instruction" class="text-base text-gray-200 mt-1"></p>
                </div>
                <div class="text-center mt-3">
                    <p class="text-sm text-gray-500">META</p>
                    <p id="target-pace" class="text-3xl font-bold text-white display-font"></p>
                </div>
            </div>
        </main>

        <!-- Secondary Metrics & Footer -->
        <footer class="w-full">
            <div class="grid grid-cols-2 gap-4 w-full text-center mb-4">
                <div>
                    <p class="text-md text-gray-400">TEMPO</p>
                    <p id="elapsed-time" class="text-5xl display-font">00:00:00</p>
                </div>
                <div>
                    <p class="text-md text-gray-400">DISTÂNCIA</p>
                    <p id="distance" class="text-5xl display-font">0.00 <span class="text-2xl text-gray-500">km</span></p>
                </div>
            </div>

            <p id="status" class="text-amber-400 h-6 mb-2 text-center">Aguardando início...</p>
            
            <div id="controls" class="flex justify-center gap-4">
                <button id="start-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-4 px-8 rounded-lg text-xl shadow-lg transition-transform transform active:scale-95">
                    INICIAR
                </button>
                <button id="pause-btn" class="w-1/2 bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-4 px-6 rounded-lg text-xl shadow-lg hidden transition-transform transform active:scale-95">
                    PAUSAR
                </button>
                <button id="stop-btn" class="w-1/2 bg-red-600 hover:bg-red-700 text-white font-bold py-4 px-6 rounded-lg text-xl shadow-lg hidden transition-transform transform active:scale-95">
                    PARAR
                </button>
            </div>
        </footer>
    </div>

    <script>
        // --- RACE INTELLIGENCE CORE ---
        // This array now contains the complete race strategy, including pace, terrain, and tactical instructions.
        const racePlan = [
            // Km 1
            { minPace: 315, maxPace: 325, terrain: "Descida Favorável", tactic: "Controle a euforia. Use a gravidade, não a força. Economize.", physiologyTip: "Respire fundo, relaxe os ombros. Deixe o corpo aquecer." },
            // Km 2
            { minPace: 320, maxPace: 330, terrain: "Descida Suave", tactic: "Mantenha o controle. Encontre seu ritmo de cruzeiro. A prova começa depois.", physiologyTip: "Sincronize sua respiração com a cadência. 2 passos inspirando, 2 expirando." },
            // Km 3
            { minPace: 325, maxPace: 335, terrain: "Plano de Transição", tactic: "Firme o ritmo. O corpo deve se sentir confortável, mas ativo.", physiologyTip: "Faça uma checagem mental: postura ereta, braços a 90 graus." },
            // Km 4
            { minPace: 340, maxPace: 350, terrain: "Primeira Subida", tactic: "Não ataque, absorva. Encurte a passada e aumente a cadência.", physiologyTip: "Incline o corpo à frente, use os braços como alavancas." },
            // Km 5
            { minPace: 330, maxPace: 340, terrain: "Plano Pós-Subida", tactic: "Recupere o ritmo de cruzeiro. Respire fundo. Hidrate-se se possível.", physiologyTip: "Solte a tensão dos ombros acumulada na subida." },
            // Km 6
            { minPace: 310, maxPace: 320, terrain: "Descida Longa", tactic: "É hora de ganhar tempo. Solte o corpo e alongue a passada.", physiologyTip: "Aproveite para recuperar o fôlego. Deixe a gravidade trabalhar." },
            // Km 7
            { minPace: 310, maxPace: 320, terrain: "Final da Descida", tactic: "Mantenha a velocidade, mas comece a se preparar mentalmente para o final.", physiologyTip: "Evite frear com o calcanhar. Aterrisse com o meio do pé." },
            // Km 8
            { minPace: 335, maxPace: 345, terrain: "Início da Subida Final", tactic: "A grande batalha começa. Mantenha a calma e o esforço constante.", physiologyTip: "Foque no horizonte, não no chão. Mantenha a cabeça erguida." },
            // Km 9
            { minPace: 350, maxPace: 365, terrain: "Pico da Subida", tactic: "Este é o teste! Foque na força mental. Use os braços vigorosamente.", physiologyTip: "A dor é temporária. Sua resistência é maior. Lembre-se do treino de 17k." },
            // Km 10
            { minPace: 325, maxPace: 345, terrain: "Sprint para o Pódio", tactic: "O pior já passou. Use toda a energia economizada. Aumente a frequência!", physiologyTip: "Contraia o abdômen. Use o core para estabilizar e impulsionar." }
        ];

        // --- UI ELEMENTS ---
        const ui = {
            currentPace: document.getElementById('current-pace'),
            targetPace: document.getElementById('target-pace'),
            currentKmLabel: document.getElementById('current-km-label'),
            elapsedTime: document.getElementById('elapsed-time'),
            distance: document.getElementById('distance'),
            status: document.getElementById('status'),
            startBtn: document.getElementById('start-btn'),
            pauseBtn: document.getElementById('pause-btn'),
            stopBtn: document.getElementById('stop-btn'),
            paceStatusText: document.getElementById('pace-status-text'),
            tacticCard: document.getElementById('tactic-card'),
            tacticTerrain: document.getElementById('tactic-terrain'),
            tacticInstruction: document.getElementById('tactic-instruction'),
        };

        // --- APP STATE ---
        let state = 'stopped';
        let watchId = null, startTime = 0, pausedTime = 0, totalPausedTime = 0;
        let totalDistance = 0, currentKm = 0;
        let positions = [];
        let mainInterval = null;
        let lastPhysiologyTipTime = 0;

        // --- CORE LOGIC ---
        const synth = window.speechSynthesis;
        function speak(text, important = false) {
            if (synth.speaking && !important) return;
            if (important) synth.cancel();
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'pt-BR';
            utterance.rate = 1.2;
            synth.speak(utterance);
        }

        function formatTime(seconds) {
            const h = Math.floor(seconds / 3600).toString().padStart(2, '0');
            const m = Math.floor((seconds % 3600) / 60).toString().padStart(2, '0');
            const s = Math.floor(seconds % 60).toString().padStart(2, '0');
            return `${h}:${m}:${s}`;
        }

        function formatPace(secondsPerKm) {
            if (!isFinite(secondsPerKm) || secondsPerKm <= 0) return '--:--';
            const minutes = Math.floor(secondsPerKm / 60).toString();
            const seconds = Math.floor(secondsPerKm % 60).toString().padStart(2, '0');
            return `${minutes}:${seconds}`;
        }

        function haversineDistance(coords1, coords2) {
            const toRad = x => x * Math.PI / 180;
            const R = 6371e3;
            const dLat = toRad(coords2.latitude - coords1.latitude);
            const dLon = toRad(coords2.longitude - coords1.longitude);
            const lat1 = toRad(coords1.latitude);
            const lat2 = toRad(coords2.latitude);
            const a = Math.sin(dLat / 2) ** 2 + Math.cos(lat1) * Math.cos(lat2) * Math.sin(dLon / 2) ** 2;
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        function updateDisplay() {
            ui.distance.innerHTML = `${(totalDistance / 1000).toFixed(2)} <span class="text-2xl text-gray-500">km</span>`;
            const elapsedSeconds = (Date.now() - startTime - totalPausedTime) / 1000;
            ui.elapsedTime.textContent = formatTime(elapsedSeconds);

            // Pace calculation based on recent GPS data for stability
            const recentPositions = positions.slice(-15);
            if (recentPositions.length > 2) {
                const firstPos = recentPositions[0];
                const lastPos = recentPositions[recentPositions.length - 1];
                const dist = haversineDistance(firstPos.coords, lastPos.coords);
                const timeDiff = (lastPos.timestamp - firstPos.timestamp) / 1000;
                
                if (dist > 5 && timeDiff > 2) {
                    const currentPaceSeconds = (timeDiff / dist) * 1000;
                    ui.currentPace.textContent = formatPace(currentPaceSeconds);
                    updatePaceFeedback(currentPaceSeconds);
                }
            }
            
            // Check for new kilometer and update strategy
            const newKm = Math.floor(totalDistance / 1000);
            if (newKm !== currentKm) {
                currentKm = newKm;
                updateStrategyUI(true); // 'true' forces animation and audio
            }

            // Give a periodic physiology tip every 90 seconds
            if (Date.now() - lastPhysiologyTipTime > 90000) {
                 const plan = racePlan[Math.min(currentKm, racePlan.length - 1)];
                 speak(plan.physiologyTip);
                 lastPhysiologyTipTime = Date.now();
            }
        }
        
        function updateStrategyUI(isNewKm = false) {
            const kmIndex = Math.min(currentKm, racePlan.length - 1);
            const plan = racePlan[kmIndex];

            ui.currentKmLabel.textContent = kmIndex + 1;
            ui.tacticTerrain.textContent = plan.terrain.toUpperCase();
            ui.tacticInstruction.textContent = plan.tactic;
            ui.targetPace.textContent = `${formatPace(plan.minPace)} - ${formatPace(plan.maxPace)}`;

            if (isNewKm) {
                ui.tacticCard.classList.remove('tactic-card-animation');
                void ui.tacticCard.offsetWidth; // Trigger reflow
                ui.tacticCard.classList.add('tactic-card-animation');
                speak(`Quilômetro ${kmIndex + 1}. ${plan.terrain}. Tática: ${plan.tactic}`, true);
            }
        }
        
        function updatePaceFeedback(currentPaceSeconds) {
            const kmIndex = Math.min(currentKm, racePlan.length - 1);
            const { minPace, maxPace } = racePlan[kmIndex];
            let statusText, bgColor, textColor;

            if (currentPaceSeconds < minPace) {
                statusText = 'CONTROLE O RITMO'; bgColor = 'bg-pace-fast'; textColor = 'text-pace-fast';
            } else if (currentPaceSeconds > maxPace) {
                statusText = 'ACELERE'; bgColor = 'bg-pace-slow'; textColor = 'text-pace-slow';
            } else {
                statusText = 'NO ALVO'; bgColor = 'bg-pace-ok'; textColor = 'text-pace-ok';
            }
            
            ui.currentPace.className = `metric-value text-8xl lg:text-9xl font-bold rounded-lg py-2 transition-all duration-300 ${bgColor} text-gray-900`;
            ui.paceStatusText.textContent = statusText;
            ui.paceStatusText.className = `text-xl font-bold h-6 transition-colors duration-300 ${textColor}`;
        }
        
        function handlePosition(position) {
            if (position.coords.accuracy > 20) {
                 ui.status.textContent = 'GPS com baixa precisão...';
                 return;
            }
            ui.status.textContent = 'GPS OK. Correndo...';
            if (positions.length > 0) {
                totalDistance += haversineDistance(positions[positions.length - 1].coords, position.coords);
            }
            positions.push(position);
        }

        function handleError(error) {
            ui.status.textContent = `Erro no GPS: ${error.message}`;
            alert(`Erro no GPS: ${error.message}. Verifique as permissões de localização do navegador.`);
        }
        
        // --- EVENT HANDLERS ---
        function startRun() {
            navigator.geolocation.getCurrentPosition(
                (pos) => { // Success
                    if (state === 'paused') {
                        totalPausedTime += Date.now() - pausedTime;
                    } else {
                        startTime = Date.now();
                        totalPausedTime = totalDistance = currentKm = 0;
                        positions = [];
                        updateStrategyUI(true);
                    }
                    
                    state = 'running';
                    ui.status.textContent = 'Obtendo sinal de GPS...';
                    lastPhysiologyTipTime = Date.now();
                    const geoOptions = { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 };
                    watchId = navigator.geolocation.watchPosition(handlePosition, handleError, geoOptions);
                    mainInterval = setInterval(updateDisplay, 1000);

                    ui.startBtn.classList.add('hidden');
                    ui.pauseBtn.classList.remove('hidden');
                    ui.stopBtn.classList.remove('hidden');
                },
                (err) => { // Error
                     handleError(err);
                }
            );
        }

        function pauseRun() {
            state = 'paused';
            pausedTime = Date.now();
            if(watchId) navigator.geolocation.clearWatch(watchId);
            if(mainInterval) clearInterval(mainInterval);
            watchId = mainInterval = null;
            
            ui.status.textContent = 'Pausado.';
            ui.pauseBtn.classList.add('hidden');
            ui.startBtn.classList.remove('hidden');
            ui.startBtn.textContent = 'RETOMAR';
        }

        function stopRun() {
            if (!confirm('Tem certeza que deseja FINALIZAR a prova?')) return;
            
            state = 'stopped';
            if (watchId) navigator.geolocation.clearWatch(watchId);
            if (mainInterval) clearInterval(mainInterval);
            
            speak(`Prova finalizada. Excelente trabalho!`, true);

            ui.startBtn.classList.remove('hidden');
            ui.startBtn.textContent = 'INICIAR';
            ui.pauseBtn.classList.add('hidden');
            ui.stopBtn.classList.add('hidden');
            resetUI();
        }
        
        function resetUI() {
             ui.currentPace.textContent = '--:--';
             ui.elapsedTime.textContent = '00:00:00';
             ui.distance.innerHTML = '0.00 <span class="text-2xl text-gray-500">km</span>';
             ui.status.textContent = 'Aguardando início...';
             ui.paceStatusText.textContent = 'AGUARDANDO';
             ui.currentPace.className = 'metric-value text-8xl lg:text-9xl font-bold rounded-lg py-2 transition-all duration-300 bg-pace-standby text-gray-800';
             updateStrategyUI();
        }

        // --- INITIALIZATION ---
        ui.startBtn.addEventListener('click', startRun);
        ui.pauseBtn.addEventListener('click', pauseRun);
        ui.stopBtn.addEventListener('click', stopRun);
        
        // Keep the screen awake
        let wakeLock = null;
        const requestWakeLock = async () => {
          if ('wakeLock' in navigator) {
            try {
              wakeLock = await navigator.wakeLock.request('screen');
            } catch (err) { /* ignore */ }
          }
        };
        requestWakeLock();
        document.addEventListener('visibilitychange', () => {
          if (wakeLock !== null && document.visibilityState === 'visible') {
            requestWakeLock();
          }
        });
        
        // Initialize the first strategy card
        updateStrategyUI();
    </script>
</body>
</html>

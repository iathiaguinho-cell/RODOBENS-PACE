<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>thIAguinho Pace Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&family=Orbitron:wght@900&display=swap" rel="stylesheet">
    <style>
        html {
            background-color: #0c0a09; /* Stone 950 */
        }
        body {
            font-family: 'Roboto Mono', monospace;
            touch-action: manipulation;
            background: radial-gradient(circle at top, #1c1917 0%, #0c0a09 100%);
            overscroll-behavior: none;
        }
        .display-font {
            font-family: 'Orbitron', sans-serif;
        }
        .metric-value {
            transition: color 0.5s ease, background-color 0.5s ease;
        }
        .bg-pace-ok { background-color: #10B981; } /* Emerald 500 */
        .text-pace-ok { color: #10B981; }
        .bg-pace-fast { background-color: #EF4444; } /* Red 500 */
        .text-pace-fast { color: #EF4444; }
        .bg-pace-slow { background-color: #3B82F6; } /* Blue 500 */
        .text-pace-slow { color: #3B82F6; }
        .bg-pace-standby { background-color: #4B5563; } /* Slate 600 */
        .text-pace-standby { color: #6B7280; } /* Slate 500 */

        @keyframes slideInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .tactic-card-animation {
            animation: slideInUp 0.6s ease-out forwards;
        }
        button {
            -webkit-tap-highlight-color: transparent;
        }
    </style>
</head>
<body class="text-gray-200 flex flex-col h-screen antialiased">

    <div id="app-container" class="flex flex-col h-full p-4 max-w-md mx-auto w-full">

        <header class="text-center pt-2">
            <h1 class="text-2xl md:text-3xl font-bold text-amber-400 display-font tracking-wider">thIAguinho Pace Pro</h1>
            <p class="text-xs md:text-sm text-gray-500">Missão: Pódio Rodobens 10K</p>
        </header>

        <main class="flex flex-col items-center justify-center gap-2 md:gap-4 flex-grow">
            
            <div class="w-full text-center">
                <p class="text-base md:text-lg text-gray-400">RITMO ATUAL (/km)</p>
                <div id="current-pace" class="metric-value text-7xl sm:text-8xl font-bold bg-pace-standby text-gray-800 rounded-lg py-2 transition-all duration-300">
                    --:--
                </div>
                <p id="pace-status-text" class="text-lg md:text-xl font-bold text-pace-standby h-6 transition-colors duration-300 mt-1">AGUARDANDO</p>
            </div>
            
            <div id="tactic-card" class="w-full bg-stone-800/50 p-3 md:p-4 rounded-lg border border-stone-700">
                 <div class="text-center">
                    <p class="text-sm md:text-base text-gray-400 font-bold tracking-widest">ESTRATÉGIA KM <span id="current-km-label" class="display-font">1</span></p>
                </div>
                <div class="text-center mt-1">
                    <p id="tactic-terrain" class="text-lg md:text-xl text-amber-400 font-bold"></p>
                    <p id="tactic-instruction" class="text-sm md:text-base text-gray-200 mt-1"></p>
                </div>
                <div class="text-center mt-2">
                    <p class="text-xs text-gray-500">META DE RITMO</p>
                    <p id="target-pace" class="text-2xl md:text-3xl font-bold text-white display-font"></p>
                </div>
            </div>
        </main>

        <footer class="w-full">
            <div class="grid grid-cols-2 gap-4 w-full text-center mb-3">
                <div>
                    <p class="text-sm md:text-md text-gray-400">TEMPO TOTAL</p>
                    <p id="elapsed-time" class="text-4xl md:text-5xl display-font">00:00:00</p>
                </div>
                <div>
                    <p class="text-sm md:text-md text-gray-400">DISTÂNCIA</p>
                    <p id="distance" class="text-4xl md:text-5xl display-font">0.00 <span class="text-xl md:text-2xl text-gray-500">km</span></p>
                </div>
            </div>

            <p id="status" class="text-amber-400 h-6 mb-2 text-center text-sm">Aguardando início...</p>
            
            <div id="controls" class="flex justify-center gap-4">
                <button id="start-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-8 rounded-lg text-xl shadow-lg transition-transform transform active:scale-95">
                    INICIAR
                </button>
                <button id="pause-btn" class="w-1/2 bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-3 px-6 rounded-lg text-xl shadow-lg hidden transition-transform transform active:scale-95">
                    PAUSAR
                </button>
                <button id="stop-btn" class="w-1/2 bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg text-xl shadow-lg hidden transition-transform transform active:scale-95">
                    PARAR
                </button>
            </div>
        </footer>
    </div>

    <script>
        // --- RACE INTELLIGENCE CORE ---
        const racePlan = [
            { minPace: 315, maxPace: 325, terrain: "Descida Favorável", tactic: "Controle a euforia. Use a gravidade, não a força." },
            { minPace: 320, maxPace: 330, terrain: "Descida Suave", tactic: "Mantenha o controle. Encontre seu ritmo de cruzeiro." },
            { minPace: 325, maxPace: 335, terrain: "Plano de Transição", tactic: "Firme o ritmo. O corpo deve se sentir confortável." },
            { minPace: 340, maxPace: 350, terrain: "Primeira Subida", tactic: "Não ataque, absorva. Encurte a passada, aumente a cadência." },
            { minPace: 330, maxPace: 340, terrain: "Plano Pós-Subida", tactic: "Recupere o ritmo de cruzeiro. Respire fundo." },
            { minPace: 310, maxPace: 320, terrain: "Descida Longa", tactic: "É hora de ganhar tempo. Solte o corpo, alongue a passada." },
            { minPace: 310, maxPace: 320, terrain: "Final da Descida", tactic: "Mantenha a velocidade, prepare a mente para o final." },
            { minPace: 335, maxPace: 345, terrain: "Início da Subida Final", tactic: "A batalha começa. Mantenha a calma, esforço constante." },
            { minPace: 350, maxPace: 365, terrain: "Pico da Subida", tactic: "Teste de força mental! Use os braços vigorosamente." },
            { minPace: 325, maxPace: 345, terrain: "Sprint para o Pódio", tactic: "Use toda a energia economizada. Aumente a frequência!" }
        ];
        
        const coachingTips = {
            general: ["Postura ereta, ombros relaxados.", "Respire fundo, oxigene o corpo.", "Mantenha os braços a 90 graus."],
            uphill: ["Incline o corpo à frente.", "Foque no horizonte, não no chão.", "Use os braços como alavancas."],
            downhill: ["Evite frear com o calcanhar.", "Aproveite para recuperar o fôlego.", "Deixe a gravidade trabalhar."]
        };

        // --- UI ELEMENTS ---
        const allUiElements = {
            currentPace: document.getElementById('current-pace'),
            targetPace: document.getElementById('target-pace'),
            currentKmLabel: document.getElementById('current-km-label'),
            elapsedTime: document.getElementById('elapsed-time'),
            distance: document.getElementById('distance'),
            status: document.getElementById('status'),
            startBtn: document.getElementById('start-btn'),
            pauseBtn: document.getElementById('pause-btn'),
            stopBtn: document.getElementById('stop-btn'),
            paceStatusText: document.getElementById('pace-status-text'),
            tacticCard: document.getElementById('tactic-card'),
            tacticTerrain: document.getElementById('tactic-terrain'),
            tacticInstruction: document.getElementById('tactic-instruction'),
        };

        // --- APP STATE ---
        let state = 'stopped';
        let watchId = null, startTime = 0, pausedTime = 0, totalPausedTime = 0;
        let totalDistance = 0, currentKm = 0;
        let positions = [];
        let mainInterval = null;
        let lastCoachMessageTime = 0;

        const synth = window.speechSynthesis;

        // --- FUNCTIONS ---

        function speak(text, important = false) {
            if (synth.speaking && !important) return;
            if (important) synth.cancel();
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'pt-BR';
            utterance.rate = 1.2;
            synth.speak(utterance);
        }

        function formatTime(seconds) {
            const h = Math.floor(seconds / 3600).toString().padStart(2, '0');
            const m = Math.floor((seconds % 3600) / 60).toString().padStart(2, '0');
            const s = Math.floor(seconds % 60).toString().padStart(2, '0');
            return `${h}:${m}:${s}`;
        }

        function formatPace(secondsPerKm) {
            if (!isFinite(secondsPerKm) || secondsPerKm <= 0) return '--:--';
            const minutes = Math.floor(secondsPerKm / 60).toString();
            const seconds = Math.floor(secondsPerKm % 60).toString().padStart(2, '0');
            return `${minutes}:${seconds}`;
        }

        function haversineDistance(coords1, coords2) {
            const toRad = x => x * Math.PI / 180;
            const R = 6371e3; // Radius of Earth in meters
            const dLat = toRad(coords2.latitude - coords1.latitude);
            const dLon = toRad(coords2.longitude - coords1.longitude);
            const lat1 = toRad(coords1.latitude);
            const lat2 = toRad(coords2.latitude);
            const a = Math.sin(dLat / 2) ** 2 + Math.cos(lat1) * Math.cos(lat2) * Math.sin(dLon / 2) ** 2;
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        function coachEngine(currentPaceSeconds) {
            const now = Date.now();
            if (now - lastCoachMessageTime < 30000 || !isFinite(currentPaceSeconds)) return; // Prevents spamming

            const plan = racePlan[Math.min(currentKm, racePlan.length - 1)];
            let tip = null;

            if (currentPaceSeconds < plan.minPace - 5) { // Significantly too fast
                tip = "Ritmo muito forte. Lembre-se do plano, guarde energia para o final.";
            } else if (currentPaceSeconds > plan.maxPace + 5) { // Significantly too slow
                tip = "Vamos buscar o ritmo. Foque na cadência, passos curtos e rápidos.";
            } else if (plan.terrain.includes("Subida")) {
                tip = coachingTips.uphill[Math.floor(Math.random() * coachingTips.uphill.length)];
            } else if (plan.terrain.includes("Descida")) {
                 tip = coachingTips.downhill[Math.floor(Math.random() * coachingTips.downhill.length)];
            } else {
                tip = coachingTips.general[Math.floor(Math.random() * coachingTips.general.length)];
            }
            
            if(tip) {
                speak(tip);
                lastCoachMessageTime = now;
            }
        }
        
        function updateDisplay() {
            allUiElements.distance.innerHTML = `${(totalDistance / 1000).toFixed(2)} <span class="text-xl md:text-2xl text-gray-500">km</span>`;
            const elapsedSeconds = (Date.now() - startTime - totalPausedTime) / 1000;
            allUiElements.elapsedTime.textContent = formatTime(elapsedSeconds);

            const recentPositions = positions.slice(-15);
            if (recentPositions.length > 2) {
                const firstPos = recentPositions[0];
                const lastPos = recentPositions[recentPositions.length - 1];
                const dist = haversineDistance(firstPos.coords, lastPos.coords);
                const timeDiff = (lastPos.timestamp - firstPos.timestamp) / 1000;
                
                if (dist > 5 && timeDiff > 2) {
                    const currentPaceSeconds = (timeDiff / dist) * 1000;
                    allUiElements.currentPace.textContent = formatPace(currentPaceSeconds);
                    updatePaceFeedback(currentPaceSeconds);
                    coachEngine(currentPaceSeconds);
                }
            }
            
            const newKm = Math.floor(totalDistance / 1000);
            if (newKm !== currentKm) {
                currentKm = newKm;
                updateStrategyUI(true);
            }
        }
        
        function updateStrategyUI(isNewKm = false) {
            const kmIndex = Math.min(currentKm, racePlan.length - 1);
            const plan = racePlan[kmIndex];

            allUiElements.currentKmLabel.textContent = kmIndex + 1;
            allUiElements.tacticTerrain.textContent = plan.terrain.toUpperCase();
            allUiElements.tacticInstruction.textContent = plan.tactic;
            allUiElements.targetPace.textContent = `${formatPace(plan.minPace)} - ${formatPace(plan.maxPace)}`;

            if (isNewKm) {
                allUiElements.tacticCard.classList.remove('tactic-card-animation');
                void allUiElements.tacticCard.offsetWidth; // Trigger reflow
                allUiElements.tacticCard.classList.add('tactic-card-animation');
                speak(`Quilômetro ${kmIndex + 1}. ${plan.terrain}. Tática: ${plan.tactic}`, true);
            }
        }
        
        function updatePaceFeedback(currentPaceSeconds) {
            const kmIndex = Math.min(currentKm, racePlan.length - 1);
            const { minPace, maxPace } = racePlan[kmIndex];
            let statusText, bgColor, textColor;

            if (currentPaceSeconds < minPace) {
                statusText = 'CONTROLE O RITMO'; bgColor = 'bg-pace-fast'; textColor = 'text-pace-fast';
            } else if (currentPaceSeconds > maxPace) {
                statusText = 'ACELERE'; bgColor = 'bg-pace-slow'; textColor = 'text-pace-slow';
            } else {
                statusText = 'NO ALVO'; bgColor = 'bg-pace-ok'; textColor = 'text-pace-ok';
            }
            
            allUiElements.currentPace.className = `metric-value text-7xl sm:text-8xl font-bold rounded-lg py-2 transition-all duration-300 ${bgColor} text-gray-800`;
            allUiElements.paceStatusText.textContent = statusText;
            allUiElements.paceStatusText.className = `text-lg md:text-xl font-bold h-6 transition-colors duration-300 mt-1 ${textColor}`;
        }
        
        function handlePosition(position) {
            if (position.coords.accuracy > 20) {
                allUiElements.status.textContent = 'GPS com baixa precisão...';
                return;
            }
            allUiElements.status.textContent = 'GPS OK. Correndo...';
            if (positions.length > 0) {
                totalDistance += haversineDistance(positions[positions.length - 1].coords, position.coords);
            }
            positions.push(position);
        }

        function handleError(error) {
            allUiElements.status.textContent = `Erro no GPS: ${error.message}`;
            alert(`Erro no GPS: ${error.message}. Verifique as permissões de localização do navegador.`);
        }

        function startRun() {
            navigator.geolocation.getCurrentPosition(
                (pos) => {
                    if (state === 'paused') {
                        totalPausedTime += Date.now() - pausedTime;
                    } else {
                        startTime = Date.now();
                        totalPausedTime = totalDistance = currentKm = 0;
                        positions = [];
                        updateStrategyUI(true);
                    }
                    state = 'running';
                    allUiElements.status.textContent = 'Obtendo sinal de GPS...';
                    lastCoachMessageTime = Date.now();
                    const geoOptions = { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 };
                    watchId = navigator.geolocation.watchPosition(handlePosition, handleError, geoOptions);
                    mainInterval = setInterval(updateDisplay, 1000);
                    allUiElements.startBtn.classList.add('hidden');
                    allUiElements.pauseBtn.classList.remove('hidden');
                    allUiElements.stopBtn.classList.remove('hidden');
                },
                (err) => {
                    handleError(err);
                }
            );
        }

        function pauseRun() {
            state = 'paused';
            pausedTime = Date.now();
            if (watchId) navigator.geolocation.clearWatch(watchId);
            if (mainInterval) clearInterval(mainInterval);
            watchId = mainInterval = null;
            allUiElements.status.textContent = 'Pausado.';
            allUiElements.pauseBtn.classList.add('hidden');
            allUiElements.startBtn.classList.remove('hidden');
            allUiElements.startBtn.textContent = 'RETOMAR';
        }

        function stopRun() {
            if (!confirm('Tem certeza que deseja FINALIZAR a prova?')) return;
            state = 'stopped';
            if (watchId) navigator.geolocation.clearWatch(watchId);
            if (mainInterval) clearInterval(mainInterval);
            speak(`Prova finalizada. Excelente trabalho!`, true);
            allUiElements.startBtn.classList.remove('hidden');
            allUiElements.startBtn.textContent = 'INICIAR';
            allUiElements.pauseBtn.classList.add('hidden');
            allUiElements.stopBtn.classList.add('hidden');
            resetUI();
        }

        function resetUI() {
            allUiElements.currentPace.textContent = '--:--';
            allUiElements.elapsedTime.textContent = '00:00:00';
            allUiElements.distance.innerHTML = '0.00 <span class="text-xl md:text-2xl text-gray-500">km</span>';
            allUiElements.status.textContent = 'Aguardando início...';
            allUiElements.paceStatusText.textContent = 'AGUARDANDO';
            allUiElements.currentPace.className = 'metric-value text-7xl sm:text-8xl font-bold rounded-lg py-2 transition-all duration-300 bg-pace-standby text-gray-800';
            updateStrategyUI();
        }
        
        async function requestWakeLock() {
            if ('wakeLock' in navigator) {
                try {
                    wakeLock = await navigator.wakeLock.request('screen');
                } catch (err) { /* ignore */ }
            }
        }
        
        // --- INITIALIZATION ---
        allUiElements.startBtn.addEventListener('click', startRun);
        allUiElements.pauseBtn.addEventListener('click', pauseRun);
        allUiElements.stopBtn.addEventListener('click', stopRun);
        
        let wakeLock = null;
        requestWakeLock();
        document.addEventListener('visibilitychange', () => {
            if (wakeLock !== null && document.visibilityState === 'visible') {
                requestWakeLock();
            }
        });
        
        updateStrategyUI();
    </script>
</body>
</html>

